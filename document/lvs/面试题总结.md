# 关于lvs面试题总结

## 1. 简单概述lvs负载均衡原理

### 1.1 NAT模式

客户端通过`Virtual IP Address`（虚拟服务的IP地址）访问网络服务时，请求报文到达调度器，调度器根据连接调度算法从一组真实服务器中选出一台服务器，将报文的目标地址`Virtual IP Address`改写成选定服务器的地址，报文的目标端口改写成选定服务器的相应端口，最后将修改后的报文发送给选出的服务器。同时，调度器在连接`Hash`表中记录这个连接，当这个连接的下一个报文到达时，从连接`Hash`表中可以得到原选定服务器的地址和端口，进行同样的改写操作，并将报文传给原选定的服务器。当来自真实服务器的响应报文经过调度器时，调度器将报文的源地址和源端口改为`Virtual IP Address`和相应的端口，再把报文发给用户。

我们在连接上引入一个状态机，不同的报文会使得连接处于不同的状态，不同的状态有不同的超时值。在`TCP`连接中，根据标准的`TCP`有限状态机进行状态迁移；在`UDP`中，我们只设置一个`UDP`状态。不同状态的超时值是可以设置的，在缺省情况下，`SYN`状态的超时为1分钟，`ESTABLISHED`状态的超时为15分钟，`FIN`状态的超时为1分钟；`UDP`状态的超时为5分钟。当连接终止或超时，调度器将这个连接从连接`Hash`表中删除。

对改写后的报文，应用增量调整`Checksum`的算法调整`TCP Checksum`的值，避免了扫描整个报文来计算`Checksum`的开销。

参考链接：http://zh.linuxvirtualserver.org/node/26
### 1.2 IP隧道

`IP`隧道（`IP tunneling`）是将一个`IP`报文封装在另一个`IP`报文的技术，这可以使得目标为一个`IP`地址的数据报文能被封装和转发到另一个`IP`地址。`IP`隧道技术亦称为`IP`封装技术（`IP encapsulation`）。`IP`隧道主要用于移动主机和虚拟私有网络（`Virtual Private Network`），在其中隧道都是静态建立的，隧道一端有一个`IP`地址，另一端也有唯一的`IP`地址。

利用`IP`隧道技术将请求报文封装转发给后端服务器，响应报文能从后端服务器直接返回给客户。但在这里，后端服务器有一组而非一个，所以我们不可能静态地建立一一对应的隧道，而是动态地选择一台服务器，将请求报文封装和转发给选出的服务器。这样，我们可以利用`IP`隧道的原理将一组服务器上的网络服务组成在一个`IP`地址上的虚拟网络服务。各个服务器将VIP地址配置在自己的IP隧道设备上。

`IP`隧道它的连接调度和管理与VS/NAT中的一样，只是它的报文转发方法不同。调度器根据各个服务器的负载情况，动态地选择一台服务器，将请求报文封装在另一个IP报文中，再将封装后的IP报文转发给选出的服务器；服务器收到报文后，先将报文解封获得原来目标地址为VIP的报文，服务器发现VIP地址被配置在本地的IP隧道设备上，所以就处理这个请求，然后根据路由表将响应报文直接返回给客户。

在VS/TUN中，响应报文根据服务器的路由表直接返回给客户，而不经过负载调度器，所以负载调度器只处于从客户到服务器的半连接中，VS/TUN的TCP状态迁移与VS/NAT的不同。VS/TUN的TCP状态迁移是按照半连接的TCP有限状态机进行的。

参考链接：http://zh.linuxvirtualserver.org/node/27
### 1.3 DR直接路由模式

跟`VS/TUN`方法相同。`VS/DR`利用大多数`Internet`服务的非对称特点，负载调度器中只负责调度请求，而服务器直接将响应返回给客户，可以极大地提高整个集群系统的吞吐量。

调度器和服务器组都必须在同一局域网，即通过交换机或者高速的HUB相连，中间没有隔有路由器。`VIP`地址为调度器和服务器组共享，调度器配置的`VIP`地址是对外可见的，用于接收虚拟服务的请求报文；所有的服务器把`VIP`地址配置在各自的`Non-ARP`网络设备上，它对外面是不可见的，只是用于处理目标地址为`VIP`的网络请求。

它的连接调度和管理与`VS/NAT`和`VS/TUN`中的一样，它的报文转发方法又有不同，将报文直接路由给目标服务器。在`VS/DR`中，调度器根据各个服务器的负载情况，动态地选择一台服务器，不修改也不封装IP报文，而是将数据帧的`MAC`地址改为选出服务器的`MAC`地址，再将修改后的数据帧在与服务器组的局域网上发送。因为数据帧的`MAC`地址是选出的服务器，所以服务器肯定可以收到这个数据帧，从中可以获得该`IP`报文。当服务器发现报文的目标地址`VIP`是在本地的网络设备上，服务器处理这个报文，然后根据路由表将响应报文直接返回给客户。

VS/DR负载调度器也只处于从客户到服务器的半连接中，按照半连接的TCP有限状态机进行状态迁移。

参考链接：http://zh.linuxvirtualserver.org/node/28
## 2. 调度算法

IPVS已实现了以下十种调度算法：

* 轮叫调度（Round-Robin Scheduling）
* 加权轮叫调度（Weighted Round-Robin Scheduling）
* 最小连接调度（Least-Connection Scheduling）
* 加权最小连接调度（Weighted Least-Connection Scheduling）
* 基于局部性的最少链接（Locality-Based Least Connections Scheduling）
* 带复制的基于局部性最少链接（Locality-Based Least Connections with Replication Scheduling）
* 目标地址散列调度（Destination Hashing Scheduling）
* 源地址散列调度（Source Hashing Scheduling）
* 最短预期延时调度（Shortest Expected Delay Scheduling）
* 不排队调度（Never Queue Scheduling）
